#!/usr/bin/env node
var debug = require('debug')('game');
var app = require('../app');


app.set('port', process.env.PORT || 3000);

var server = app.listen(app.get('port'), function() {
  console.log('Express server listening on port ' + server.address().port)
  debug('Express server listening on port ' + server.address().port);  

});

var clients = 0
var movers = []

var io = require('socket.io').listen(server);
io.sockets.on('connection', function(socket) {
  
  socket.emit('connected', socket.id, movers);

  clients += 1;
  console.log(socket.id)
  console.log(clients + "connected")
  socket.on('move', function(direction) {
    socket.broadcast.emit('move', direction);
  });

  socket.on("new_game", function(player) {
    socket.broadcast.emit('new_game', [player]);
    movers.push(player)
  });

  socket.on("playerposition", function(player) {
    // movers 
    socket.broadcast.emit('playerposition', player);  
  });

  socket.on("new_player", function(new_player) {
    socket.broadcast.emit('new_player', new_player);
    movers.push(new_player)
  });




  socket.on('disconnect', function () {
    console.log('client disconnected');
    console.log(socket.id)
    console.log("***" + movers)
    if (movers) {
      for(var i = 0 ; i < movers.length; i++) {
          if (movers[i].client_id == socket.id) {
            movers.splice(i,1)
            socket.broadcast.emit('player_removed', socket.id);
          }
      }
    }
    clients -= 1;
  });
})
